#!/bin/bash
function dead {
  echo $*
  exit ;
}

(pwd | grep current >/dev/null 2>&1) || dead 'ERROR: You need to execute from "Current"'
VERSION=$(grep Version: ../packages/fuduntu/jupiter.spec  | awk '{print $2}')
BUILDPKG="jupiter"
PKGROOT=$(pwd | sed s#/[0-9]\.[0-9]/$BUILDPKG-current##)
PRJROOT="$HOME/Projects/jupiter"
cd ..
echo "Copying [$BUILDPKG-current] to [build/$BUILDPKG-$VERSION]"
cp -rf $BUILDPKG-current $PRJROOT/build/$BUILDPKG-$VERSION
echo "Moving to [$PRJROOT/build/$BUILDPKG-$VERSION]"
cd $PRJROOT/build/$BUILDPKG-$VERSION
echo "Cleaning directory [$(pwd)]"
rm -rf `find . | grep svn$`
echo -n "Building Package .. "
cd ..
tar -czf $BUILDPKG\_$VERSION.tar.gz $BUILDPKG-$VERSION
if [ ! -e "$HOME/rpmbuild/SOURCES/" ]; then
  echo "Creating SOURCE directory"
  mkdir -p $HOME/rpmbuild/SOURCES/
fi
cp -f $PRJROOT/build/$BUILDPKG\_$VERSION.tar.gz $HOME/rpmbuild/SOURCES/
rpmbuild --sign -bb $PRJROOT/packages/fuduntu/jupiter-support-eee.spec >build.log 2>&1
if [ $? -eq 0 ]; then
  echo "[SUCCESS]"
  cp $HOME/rpmbuild/RPMS/noarch/$BUILDPKG-$VERSION-$(cat $PRJROOT/packages/fuduntu/jupiter-support-eee.spec | awk '/Release/ {printf $2}').noarch.rpm .
else
  echo "[FAILED]"
fi
echo "Please review [build.log] for important information about your package"
cd ..
